# SGM5860x 自适应卡尔曼滤波器集成说明

## 概述

本文档说明了如何在 SGM5860x ADC 设备驱动中使用自适应卡尔曼滤波器来提高数据采集的精度和稳定性。

## 🎯 功能特性

### 1. 自适应滤波
- **智能参数调整**：根据信号特性自动调整滤波器参数
- **增益自适应**：根据不同的ADC增益设置优化滤波参数
- **实时监控**：提供滤波器状态和性能监控

### 2. 多通道支持
- **独立滤波器**：每个ADC通道都有独立的卡尔曼滤波器
- **参数优化**：根据通道增益自动设置最优参数
- **健康检查**：定期检查滤波器状态，自动修复异常

### 3. 命令行接口
- **实时控制**：通过命令行实时查看和控制滤波器
- **性能统计**：提供详细的滤波器性能统计信息
- **参数调优**：支持运行时动态调整滤波器参数

## 🔧 编译配置

### 滤波器模式选择
```c
#define KALMAN_FILTER_MODE (1)  // 卡尔曼滤波器模式
#define AVG_FILTER_MODE    (0)  // 平均滤波器模式
#define FILTER_MODE        (KALMAN_FILTER_MODE)  // 选择滤波器模式
```

### 包含头文件
```c
#if FILTER_MODE == KALMAN_FILTER_MODE
#include "kalman_filter.h"
#elif FILTER_MODE == AVG_FILTER_MODE
#define AVG_MAX_CNT (10)
#endif
```

## 📊 通道配置

### 自动参数设置
系统会根据每个通道的增益自动设置最优的滤波器参数：

| 增益范围 | 过程噪声Q | 测量噪声R | 自适应速率 | 适用场景 |
|----------|-----------|-----------|------------|----------|
| 1x-4x    | 0.005     | 0.05      | 0.08       | 大信号，低噪声 |
| 8x-32x   | 0.01      | 0.1       | 0.08       | 中等信号 |
| 64x-128x | 0.02      | 0.2       | 0.15       | 小信号，高噪声 |

### 通道配置示例
```c
ChannelCfg_t sgm5860_channelcfg[sgm5860xChannelMax] = {
    {0, SGM58601_GAIN_1},    // 通道0：增益1倍
    {2, SGM58601_GAIN_1},    // 通道2：增益1倍
    {4, SGM58601_GAIN_1},    // 通道4：增益1倍
    {6, SGM58601_GAIN_128},  // 通道6：增益128倍
};
```

## 🚀 使用方法

### 1. 基本数据读取
```bash
# 读取所有通道的数据
sgm5860x data
```

输出示例：
```
Index 0 Channel 0: Raw=1.234567 V, Filtered=1.234568 V (1234.6 mV, 1234568.0 uV)
Index 1 Channel 2: Raw=2.345678 V, Filtered=2.345679 V (2345.7 mV, 2345679.0 uV)
Index 2 Channel 4: Raw=3.456789 V, Filtered=3.456790 V (3456.8 mV, 3456790.0 uV)
Index 3 Channel 6: Raw=0.001234 V, Filtered=0.001235 V (1.2 mV, 1235.0 uV)
```

### 2. 卡尔曼滤波器控制

#### 查看滤波器状态
```bash
# 查看所有通道的状态
sgm5860x kalman status

# 查看特定通道的状态
sgm5860x kalman status 0
```

#### 查看性能统计
```bash
# 查看特定通道的性能统计
sgm5860x kalman stats 0
```

输出示例：
```
Channel 0 Performance Statistics:
  Tracking Accuracy: 0.9876
  Filter Stability: 0.9543
  Convergence Speed: 0.8765
  Q Drift: 12.34%
  R Drift: 8.76%
  Total Adaptations: 1234
  State Changes: 56
  Samples: 12345
```

#### 健康检查
```bash
# 检查所有通道的健康状态
sgm5860x kalman check

# 检查特定通道
sgm5860x kalman check 0
```

#### 重置滤波器
```bash
# 重置所有通道的滤波器
sgm5860x kalman reset

# 重置特定通道的滤波器
sgm5860x kalman reset 0
```

#### 参数调优
```bash
# 调整通道0的参数：响应性0.8，稳定性0.6
sgm5860x kalman tune 0 0.8 0.6
```

参数说明：
- **响应性 (0.1-1.0)**：数值越高，滤波器对信号变化的响应越快
- **稳定性 (0.1-1.0)**：数值越高，滤波器越稳定，但响应可能较慢

## 📈 性能监控

### 自动监控功能
- **每100个样本**：进行一次健康检查，自动修复异常
- **每1000个样本**：打印性能统计信息到日志

### 监控指标
1. **跟踪准确性**：滤波器跟踪真实信号的能力
2. **滤波器稳定性**：滤波器参数的稳定程度
3. **收敛速度**：滤波器达到稳定状态的速度
4. **参数漂移**：Q和R参数相对于初始值的漂移程度

## 🛠️ 故障排除

### 常见问题

1. **滤波器未初始化**
   - 现象：日志显示 "Kalman filter not initialized"
   - 解决：确保设备已正确启动，检查初始化日志

2. **数值不稳定**
   - 现象：滤波器自检返回 UNSTABLE 错误
   - 解决：滤波器会自动重置，也可手动重置

3. **跟踪性能差**
   - 现象：滤波器自检返回 POOR_TRACKING 错误
   - 解决：调整参数或重置滤波器

### 调试技巧

1. **启用调试日志**
   ```c
   #define sgm5860xLogLvl ELOG_LVL_DEBUG
   ```

2. **监控关键指标**
   - 定期检查滤波器状态
   - 监控参数漂移情况
   - 观察信号状态变化

3. **参数调优建议**
   - 对于稳定信号：提高稳定性参数
   - 对于快变信号：提高响应性参数
   - 对于噪声信号：降低响应性参数

## 📝 开发指南

### 添加新通道
1. 修改 `sgm5860xChannelMax` 定义
2. 在 `sgm5860_channelcfg` 中添加通道配置
3. 系统会自动为新通道创建滤波器

### 自定义滤波器参数
在 `sgm5860x_kalman_filter_init()` 函数中修改：
```c
// 自定义参数
double process_noise = 0.01;    // 过程噪声
double measurement_noise = 0.1; // 测量噪声
```

### 集成到其他项目
1. 复制卡尔曼滤波器相关代码
2. 包含必要的头文件
3. 根据需要修改通道配置
4. 调整日志输出和命令接口

## 🔄 版本更新

### v1.0 (当前版本)
- ✅ 完整的自适应卡尔曼滤波器集成
- ✅ 多通道独立滤波支持
- ✅ 自动参数优化
- ✅ 实时监控和健康检查
- ✅ 命令行接口
- ✅ 性能统计和调优

### 未来计划
- 🔄 数据记录和回放功能
- 🔄 滤波器参数自学习
- 🔄 多传感器融合滤波
- 🔄 Web界面监控

## 📞 技术支持

如果在使用过程中遇到问题，请：
1. 检查编译配置是否正确
2. 查看系统日志获取详细信息
3. 使用命令行工具进行诊断
4. 参考本文档的故障排除部分

---

**自适应卡尔曼滤波器 - 让您的ADC数据更精准、更稳定！** 🎯
