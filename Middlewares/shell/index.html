<!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="OpenIBBOs 零拷贝通信框架文档"><meta name=author content="OpenIBBOs Team"><link href=https://yourusername.github.io/OpenIBBOs/Middlewares/shell/ rel=canonical><link href=../../zero_topic_core/topic_bus/multi_mcu_microros_communication/ rel=prev><link href=../../CONTRIBUTING/ rel=next><link rel=icon href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.6.23"><title>Shell组件 - OpenIBBOs Wiki</title><link rel=stylesheet href=../../assets/stylesheets/main.84d31ad4.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=blue data-md-color-accent=blue> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#letter-shell-3x class=md-skip> 跳转至 </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=页眉> <a href=../.. title="OpenIBBOs Wiki" class="md-header__button md-logo" aria-label="OpenIBBOs Wiki" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> OpenIBBOs Wiki </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Shell组件 </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=blue data-md-color-accent=blue aria-label=切换到深色模式 type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title=切换到深色模式 for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary=blue data-md-color-accent=blue aria-label=切换到浅色模式 type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title=切换到浅色模式 for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=搜索 placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=查找> <button type=reset class="md-search__icon md-icon" title=清空当前内容 aria-label=清空当前内容 tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> 正在初始化搜索引擎 </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=标签 data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> 首页 </a> </li> <li class=md-tabs__item> <a href=../../getting-started/ class=md-tabs__link> 快速开始 </a> </li> <li class=md-tabs__item> <a href=../../zero_topic_core/topic_bus/topic_bus/ class=md-tabs__link> 核心概念 </a> </li> <li class=md-tabs__item> <a href=../../zero_topic_core/topic_bus/hardware_thread_vs_direct_api_analysis/ class=md-tabs__link> 架构设计 </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=./ class=md-tabs__link> 中间件 </a> </li> <li class=md-tabs__item> <a href=../../CONTRIBUTING/ class=md-tabs__link> 开发指南 </a> </li> <li class=md-tabs__item> <a href=../../CHANGELOG/ class=md-tabs__link> 更新日志 </a> </li> <li class=md-tabs__item> <a href=../../DOCS_README/ class=md-tabs__link> 其他文档 </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=导航栏 data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="OpenIBBOs Wiki" class="md-nav__button md-logo" aria-label="OpenIBBOs Wiki" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> OpenIBBOs Wiki </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> <span class=md-ellipsis> 首页 </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex=0> <span class=md-ellipsis> 快速开始 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> 快速开始 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../getting-started/ class=md-nav__link> <span class=md-ellipsis> 快速开始 </span> </a> </li> <li class=md-nav__item> <a href=../../installation/ class=md-nav__link> <span class=md-ellipsis> 安装指南 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex=0> <span class=md-ellipsis> 核心概念 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> 核心概念 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../zero_topic_core/topic_bus/topic_bus/ class=md-nav__link> <span class=md-ellipsis> Topic 总线 </span> </a> </li> <li class=md-nav__item> <a href=../../zero_topic_core/obj_dict/obj_dict/ class=md-nav__link> <span class=md-ellipsis> 对象字典 </span> </a> </li> <li class=md-nav__item> <a href=../../zero_topic_core/ring_buffer/ring_buffer/ class=md-nav__link> <span class=md-ellipsis> 环形缓冲区 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex=0> <span class=md-ellipsis> 架构设计 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> 架构设计 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../zero_topic_core/topic_bus/hardware_thread_vs_direct_api_analysis/ class=md-nav__link> <span class=md-ellipsis> 硬件线程 vs 直接API </span> </a> </li> <li class=md-nav__item> <a href=../../zero_topic_core/topic_bus/mcu_hardware_optimization_analysis/ class=md-nav__link> <span class=md-ellipsis> MCU硬件优化 </span> </a> </li> <li class=md-nav__item> <a href=../../zero_topic_core/topic_bus/multi_mcu_microros_communication/ class=md-nav__link> <span class=md-ellipsis> 多MCU microROS通信 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5 checked> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex> <span class=md-ellipsis> 中间件 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=true> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> 中间件 </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> Shell组件 </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Shell组件 </span> </a> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> <span class=md-ellipsis> 简介 </span> </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> <span class=md-ellipsis> 功能 </span> </a> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> <span class=md-ellipsis> 移植说明 </span> </a> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> <span class=md-ellipsis> 使用方式 </span> </a> <nav class=md-nav aria-label=使用方式> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_5 class=md-nav__link> <span class=md-ellipsis> 函数定义 </span> </a> <nav class=md-nav aria-label=函数定义> <ul class=md-nav__list> <li class=md-nav__item> <a href=#main class=md-nav__link> <span class=md-ellipsis> main函数形式 </span> </a> </li> <li class=md-nav__item> <a href=#c class=md-nav__link> <span class=md-ellipsis> 普通C函数形式 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_6 class=md-nav__link> <span class=md-ellipsis> 变量使用 </span> </a> </li> <li class=md-nav__item> <a href=#shell class=md-nav__link> <span class=md-ellipsis> 在函数中获取当前shell对象 </span> </a> </li> <li class=md-nav__item> <a href=#_7 class=md-nav__link> <span class=md-ellipsis> 执行未导出函数 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_8 class=md-nav__link> <span class=md-ellipsis> 命令定义 </span> </a> <nav class=md-nav aria-label=命令定义> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_9 class=md-nav__link> <span class=md-ellipsis> 定义方式 </span> </a> </li> <li class=md-nav__item> <a href=#_10 class=md-nav__link> <span class=md-ellipsis> 定义宏说明 </span> </a> </li> <li class=md-nav__item> <a href=#_11 class=md-nav__link> <span class=md-ellipsis> 命令属性字段说明 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_12 class=md-nav__link> <span class=md-ellipsis> 代理函数和代理参数解析 </span> </a> </li> <li class=md-nav__item> <a href=#_13 class=md-nav__link> <span class=md-ellipsis> 函数签名 </span> </a> <nav class=md-nav aria-label=函数签名> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_14 class=md-nav__link> <span class=md-ellipsis> 自定义类型解析 </span> </a> </li> <li class=md-nav__item> <a href=#_15 class=md-nav__link> <span class=md-ellipsis> 数组参数 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_16 class=md-nav__link> <span class=md-ellipsis> 权限系统说明 </span> </a> </li> <li class=md-nav__item> <a href=#_17 class=md-nav__link> <span class=md-ellipsis> 锁说明 </span> </a> </li> <li class=md-nav__item> <a href=#_18 class=md-nav__link> <span class=md-ellipsis> 伴生对象 </span> </a> </li> <li class=md-nav__item> <a href=#_19 class=md-nav__link> <span class=md-ellipsis> 尾行模式 </span> </a> </li> <li class=md-nav__item> <a href=#_20 class=md-nav__link> <span class=md-ellipsis> 建议终端软件 </span> </a> </li> <li class=md-nav__item> <a href=#_21 class=md-nav__link> <span class=md-ellipsis> 命令遍历工具 </span> </a> </li> <li class=md-nav__item> <a href=#x86-demo class=md-nav__link> <span class=md-ellipsis> x86 demo </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6 id=__nav_6_label tabindex=0> <span class=md-ellipsis> 开发指南 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=false> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> 开发指南 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../CONTRIBUTING/ class=md-nav__link> <span class=md-ellipsis> 贡献指南 </span> </a> </li> <li class=md-nav__item> <a href=../../Doc/wsl_cmake_gcc/ class=md-nav__link> <span class=md-ellipsis> WSL/CMake/GCC </span> </a> </li> <li class=md-nav__item> <a href=../../Doc/todo_list/ class=md-nav__link> <span class=md-ellipsis> TODO列表 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../CHANGELOG/ class=md-nav__link> <span class=md-ellipsis> 更新日志 </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_8> <label class=md-nav__link for=__nav_8 id=__nav_8_label tabindex=0> <span class=md-ellipsis> 其他文档 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_8_label aria-expanded=false> <label class=md-nav__title for=__nav_8> <span class="md-nav__icon md-icon"></span> 其他文档 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../DOCS_README/ class=md-nav__link> <span class=md-ellipsis> 文档使用说明 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> <span class=md-ellipsis> 简介 </span> </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> <span class=md-ellipsis> 功能 </span> </a> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> <span class=md-ellipsis> 移植说明 </span> </a> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> <span class=md-ellipsis> 使用方式 </span> </a> <nav class=md-nav aria-label=使用方式> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_5 class=md-nav__link> <span class=md-ellipsis> 函数定义 </span> </a> <nav class=md-nav aria-label=函数定义> <ul class=md-nav__list> <li class=md-nav__item> <a href=#main class=md-nav__link> <span class=md-ellipsis> main函数形式 </span> </a> </li> <li class=md-nav__item> <a href=#c class=md-nav__link> <span class=md-ellipsis> 普通C函数形式 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_6 class=md-nav__link> <span class=md-ellipsis> 变量使用 </span> </a> </li> <li class=md-nav__item> <a href=#shell class=md-nav__link> <span class=md-ellipsis> 在函数中获取当前shell对象 </span> </a> </li> <li class=md-nav__item> <a href=#_7 class=md-nav__link> <span class=md-ellipsis> 执行未导出函数 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_8 class=md-nav__link> <span class=md-ellipsis> 命令定义 </span> </a> <nav class=md-nav aria-label=命令定义> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_9 class=md-nav__link> <span class=md-ellipsis> 定义方式 </span> </a> </li> <li class=md-nav__item> <a href=#_10 class=md-nav__link> <span class=md-ellipsis> 定义宏说明 </span> </a> </li> <li class=md-nav__item> <a href=#_11 class=md-nav__link> <span class=md-ellipsis> 命令属性字段说明 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_12 class=md-nav__link> <span class=md-ellipsis> 代理函数和代理参数解析 </span> </a> </li> <li class=md-nav__item> <a href=#_13 class=md-nav__link> <span class=md-ellipsis> 函数签名 </span> </a> <nav class=md-nav aria-label=函数签名> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_14 class=md-nav__link> <span class=md-ellipsis> 自定义类型解析 </span> </a> </li> <li class=md-nav__item> <a href=#_15 class=md-nav__link> <span class=md-ellipsis> 数组参数 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_16 class=md-nav__link> <span class=md-ellipsis> 权限系统说明 </span> </a> </li> <li class=md-nav__item> <a href=#_17 class=md-nav__link> <span class=md-ellipsis> 锁说明 </span> </a> </li> <li class=md-nav__item> <a href=#_18 class=md-nav__link> <span class=md-ellipsis> 伴生对象 </span> </a> </li> <li class=md-nav__item> <a href=#_19 class=md-nav__link> <span class=md-ellipsis> 尾行模式 </span> </a> </li> <li class=md-nav__item> <a href=#_20 class=md-nav__link> <span class=md-ellipsis> 建议终端软件 </span> </a> </li> <li class=md-nav__item> <a href=#_21 class=md-nav__link> <span class=md-ellipsis> 命令遍历工具 </span> </a> </li> <li class=md-nav__item> <a href=#x86-demo class=md-nav__link> <span class=md-ellipsis> x86 demo </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=letter-shell-3x>letter shell 3.x<a class=headerlink href=#letter-shell-3x title="Permanent link">&para;</a></h1> <p><img alt=version src=https://img.shields.io/badge/version-3.2.4-brightgreen.svg> <img alt=standard src=https://img.shields.io/badge/standard-c99-brightgreen.svg> <img alt=build src=https://img.shields.io/badge/build-2024.07.31-brightgreen.svg> <img alt=license src=https://img.shields.io/badge/license-MIT-brightgreen.svg></p> <p>一个功能强大的嵌入式shell</p> <p><img alt=shell_info.png src=doc/img/shell_info.png></p> <ul> <li><a href=#letter-shell-3x>letter shell 3.x</a></li> <li><a href=#简介>简介</a></li> <li><a href=#功能>功能</a></li> <li><a href=#移植说明>移植说明</a></li> <li><a href=#使用方式>使用方式</a><ul> <li><a href=#函数定义>函数定义</a></li> <li><a href=#main函数形式>main函数形式</a></li> <li><a href=#普通c函数形式>普通C函数形式</a></li> <li><a href=#变量使用>变量使用</a></li> <li><a href=#在函数中获取当前shell对象>在函数中获取当前shell对象</a></li> <li><a href=#执行未导出函数>执行未导出函数</a></li> </ul> </li> <li><a href=#命令定义>命令定义</a><ul> <li><a href=#定义方式>定义方式</a></li> <li><a href=#定义宏说明>定义宏说明</a></li> <li><a href=#命令属性字段说明>命令属性字段说明</a></li> </ul> </li> <li><a href=#代理函数和代理参数解析>代理函数和代理参数解析</a></li> <li><a href=#函数签名>函数签名</a><ul> <li><a href=#自定义类型解析>自定义类型解析</a></li> <li><a href=#数组参数>数组参数</a></li> </ul> </li> <li><a href=#权限系统说明>权限系统说明</a></li> <li><a href=#锁说明>锁说明</a></li> <li><a href=#伴生对象>伴生对象</a></li> <li><a href=#尾行模式>尾行模式</a></li> <li><a href=#建议终端软件>建议终端软件</a></li> <li><a href=#命令遍历工具>命令遍历工具</a></li> <li><a href=#x86-demo>x86 demo</a></li> </ul> <h2 id=_1>简介<a class=headerlink href=#_1 title="Permanent link">&para;</a></h2> <p><a href=https://github.com/NevermindZZT/letter-shell>letter shell</a>是一个C语言编写的，可以嵌入在程序中的嵌入式shell，主要面向嵌入式设备，以C语言函数为运行单位，可以通过命令行调用，运行程序中的函数</p> <p>相对2.x版本，letter shell 3.x增加了用户管理，权限管理，以及对文件系统的初步支持</p> <p>此外3.x版本修改了命令格式和定义，2.x版本的工程需要经过简单的修改才能完成迁移</p> <p>若只需要使用基础功能，可以使用<a href=https://github.com/NevermindZZT/letter-shell/tree/shell2.x>letter shell 2.x</a>版本</p> <p>使用说明可参考<a href=https://nevermindzzt.github.io/2020/01/19/Letter%20shell%203.0%E5%85%A8%E6%96%B0%E5%87%BA%E5%8F%91/ >Letter shell 3.0 全新出发</a></p> <p>如果从3.0版本迁移到3.1以上版本，请注意3.1版本对读写函数原型的修改</p> <h2 id=_2>功能<a class=headerlink href=#_2 title="Permanent link">&para;</a></h2> <ul> <li>命令自动补全</li> <li>快捷键功能定义</li> <li>命令权限管理</li> <li>用户管理</li> <li>变量支持</li> <li>代理函数和参数代理解析</li> </ul> <h2 id=_3>移植说明<a class=headerlink href=#_3 title="Permanent link">&para;</a></h2> <ol> <li> <p>定义shell对象</p> <div class=highlight><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=n>Shell</span><span class=w> </span><span class=n>shell</span><span class=p>;</span>
</code></pre></div> </li> <li> <p>定义shell读，写函数</p> <p>对于使用letter shell 3.0版本，读写函数原型如下：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=cm>/**</span>
<a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=cm> * @brief shell读取数据函数原型</span>
<a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=cm> *</span>
<a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a><span class=cm> * @param char shell读取的字符</span>
<a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a><span class=cm> *</span>
<a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a><span class=cm> * @return char 0 读取数据成功</span>
<a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a><span class=cm> * @return char -1 读取数据失败</span>
<a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a><span class=cm> */</span>
<a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a><span class=k>typedef</span><span class=w> </span><span class=kt>signed</span><span class=w> </span><span class=nf>char</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=n>shellRead</span><span class=p>)(</span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=p>);</span>
<a id=__codelineno-1-10 name=__codelineno-1-10 href=#__codelineno-1-10></a>
<a id=__codelineno-1-11 name=__codelineno-1-11 href=#__codelineno-1-11></a><span class=cm>/**</span>
<a id=__codelineno-1-12 name=__codelineno-1-12 href=#__codelineno-1-12></a><span class=cm> * @brief shell写数据函数原型</span>
<a id=__codelineno-1-13 name=__codelineno-1-13 href=#__codelineno-1-13></a><span class=cm> *</span>
<a id=__codelineno-1-14 name=__codelineno-1-14 href=#__codelineno-1-14></a><span class=cm> * @param const char 需写的字符</span>
<a id=__codelineno-1-15 name=__codelineno-1-15 href=#__codelineno-1-15></a><span class=cm> */</span>
<a id=__codelineno-1-16 name=__codelineno-1-16 href=#__codelineno-1-16></a><span class=k>typedef</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=n>shellWrite</span><span class=p>)(</span><span class=k>const</span><span class=w> </span><span class=kt>char</span><span class=p>);</span>
</code></pre></div> <p>对于使用letter shell 3.1版本，为了优化效率，修改了读写函数原型，如下：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=cm>/**</span>
<a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=cm> * @brief shell读取数据函数原型</span>
<a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=cm> *</span>
<a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a><span class=cm> * @param data shell读取的字符</span>
<a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a><span class=cm> * @param len 请求读取的字符数量</span>
<a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a><span class=cm> *</span>
<a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a><span class=cm> * @return unsigned short 实际读取到的字符数量</span>
<a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a><span class=cm> */</span>
<a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a><span class=k>typedef</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=nf>short</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=n>shellRead</span><span class=p>)(</span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>data</span><span class=p>,</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>short</span><span class=w> </span><span class=n>len</span><span class=p>);</span>
<a id=__codelineno-2-10 name=__codelineno-2-10 href=#__codelineno-2-10></a>
<a id=__codelineno-2-11 name=__codelineno-2-11 href=#__codelineno-2-11></a><span class=cm>/**</span>
<a id=__codelineno-2-12 name=__codelineno-2-12 href=#__codelineno-2-12></a><span class=cm> * @brief shell写数据函数原型</span>
<a id=__codelineno-2-13 name=__codelineno-2-13 href=#__codelineno-2-13></a><span class=cm> *</span>
<a id=__codelineno-2-14 name=__codelineno-2-14 href=#__codelineno-2-14></a><span class=cm> * @param data 需写的字符数据</span>
<a id=__codelineno-2-15 name=__codelineno-2-15 href=#__codelineno-2-15></a><span class=cm> * @param len 需要写入的字符数</span>
<a id=__codelineno-2-16 name=__codelineno-2-16 href=#__codelineno-2-16></a><span class=cm> *</span>
<a id=__codelineno-2-17 name=__codelineno-2-17 href=#__codelineno-2-17></a><span class=cm> * @return unsigned short 实际写入的字符数量</span>
<a id=__codelineno-2-18 name=__codelineno-2-18 href=#__codelineno-2-18></a><span class=cm> */</span>
<a id=__codelineno-2-19 name=__codelineno-2-19 href=#__codelineno-2-19></a><span class=k>typedef</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=nf>short</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=n>shellWrite</span><span class=p>)(</span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>data</span><span class=p>,</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>short</span><span class=w> </span><span class=n>len</span><span class=p>);</span>
</code></pre></div> </li> <li> <p>申请一片缓冲区</p> <div class=highlight><pre><span></span><code><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=kt>char</span><span class=w> </span><span class=n>shellBuffer</span><span class=p>[</span><span class=mi>512</span><span class=p>];</span>
</code></pre></div> </li> <li> <p>调用shellInit进行初始化</p> <div class=highlight><pre><span></span><code><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=n>shell</span><span class=p>.</span><span class=n>read</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>shellRead</span><span class=p>;</span>
<a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a><span class=n>shell</span><span class=p>.</span><span class=n>write</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>shellWrite</span><span class=p>;</span>
<a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a><span class=n>shellInit</span><span class=p>(</span><span class=o>&amp;</span><span class=n>shell</span><span class=p>,</span><span class=w> </span><span class=n>shellBuffer</span><span class=p>,</span><span class=w> </span><span class=mi>512</span><span class=p>);</span>
</code></pre></div> </li> <li> <p>调用(建立)shell任务</p> <p>对于运行在操作系统的情况，建立<code>shellTask</code>任务(确保sell_cfg.h中的配置无误)，任务参数为shell对象</p> <div class=highlight><pre><span></span><code><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=n>OsTaskCreate</span><span class=p>(</span><span class=n>shellTask</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>shell</span><span class=p>,</span><span class=w> </span><span class=p>...);</span>
</code></pre></div> <p>对于裸机环境，在主循环中调用<code>shellTask</code>，或者在接收到数据时，调用<code>shellHandler</code></p> </li> <li> <p>说明</p> </li> <li> <p>对于中断方式使用shell，不用定义<code>shell-&gt;read</code>，但需要在中断中调用<code>shellHandler</code></p> </li> <li> <p>对于使用操作系统的情况，使能<code>SHEHLL_TASK_WHILE</code>宏，然后创建shellTask任务</p> </li> <li> <p>其他配置</p> </li> <li> <p>定义宏<code>SHELL_GET_TICK()</code>为获取系统tick函数，使能tab双击操作，用户长帮助补全</p> </li> <li> <p>配置宏</p> <p>shell_cfg.h文件中包含了所有用于配置shell的宏，在使用前，需要根据需要进行配置</p> <p>建议采用 overlay 的方式，新建一个头文件，例如 <code>shell_cfg_user.h</code>，然后定义编译宏 <code>SHELL_CFG_USER="shell_cfg_user.h"</code>，在这个头文件中添加需要修改的配置即可</p> <table> <thead> <tr> <th>宏</th> <th>意义</th> </tr> </thead> <tbody> <tr> <td>SHELL_TASK_WHILE</td> <td>是否使用默认shell任务while循环</td> </tr> <tr> <td>SHELL_USING_CMD_EXPORT</td> <td>是否使用命令导出方式</td> </tr> <tr> <td>SHELL_USING_COMPANION</td> <td>是否使用shell伴生对象功能</td> </tr> <tr> <td>SHELL_SUPPORT_END_LINE</td> <td>是否支持shell尾行模式</td> </tr> <tr> <td>SHELL_HELP_LIST_USER</td> <td>是否在输入命令列表中列出用户</td> </tr> <tr> <td>SHELL_HELP_LIST_VAR</td> <td>是否在输入命令列表中列出变量</td> </tr> <tr> <td>SHELL_HELP_LIST_KEY</td> <td>是否在输入命令列表中列出按键</td> </tr> <tr> <td>SHELL_ENTER_LF</td> <td>使用LF作为命令行回车触发</td> </tr> <tr> <td>SHELL_ENTER_CR</td> <td>使用CR作为命令行回车触发</td> </tr> <tr> <td>SHELL_ENTER_CRLF</td> <td>使用CRLF作为命令行回车触发</td> </tr> <tr> <td>SHELL_EXEC_UNDEF_FUNC</td> <td>使用执行未导出函数的功能</td> </tr> <tr> <td>SHELL_COMMAND_MAX_LENGTH</td> <td>shell命令最大长度</td> </tr> <tr> <td>SHELL_PARAMETER_MAX_NUMBER</td> <td>shell命令参数最大数量</td> </tr> <tr> <td>SHELL_HISTORY_MAX_NUMBER</td> <td>历史命令记录数量</td> </tr> <tr> <td>SHELL_DOUBLE_CLICK_TIME</td> <td>双击间隔(ms)</td> </tr> <tr> <td>SHELL_QUICK_HELP</td> <td>快速帮助</td> </tr> <tr> <td>SHELL_MAX_NUMBER</td> <td>管理的最大shell数量</td> </tr> <tr> <td>SHELL_GET_TICK()</td> <td>获取系统时间(ms)</td> </tr> <tr> <td>SHELL_USING_LOCK</td> <td>是否使用锁</td> </tr> <tr> <td>SHELL_MALLOC(size)</td> <td>内存分配函数(shell本身不需要)</td> </tr> <tr> <td>SHELL_FREE(obj)</td> <td>内存释放函数(shell本身不需要)</td> </tr> <tr> <td>SHELL_SHOW_INFO</td> <td>是否显示shell信息</td> </tr> <tr> <td>SHELL_CLS_WHEN_LOGIN</td> <td>是否在登录后清除命令行</td> </tr> <tr> <td>SHELL_DEFAULT_USER</td> <td>shell默认用户</td> </tr> <tr> <td>SHELL_DEFAULT_USER_PASSWORD</td> <td>默认用户密码</td> </tr> <tr> <td>SHELL_LOCK_TIMEOUT</td> <td>shell自动锁定超时</td> </tr> <tr> <td>SHELL_USING_FUNC_SIGNATURE</td> <td>使用函数签名</td> </tr> <tr> <td>SHELL_SUPPORT_ARRAY_PARAM</td> <td>支持数组参数</td> </tr> </tbody> </table> </li> </ol> <h2 id=_4>使用方式<a class=headerlink href=#_4 title="Permanent link">&para;</a></h2> <h3 id=_5>函数定义<a class=headerlink href=#_5 title="Permanent link">&para;</a></h3> <p>letter shell 3.x同时支持两种形式的函数定义方式，形如main函数定义的<code>func(int argc, char *agrv[])</code>以及形如普通C函数的定义<code>func(int i, char *str, ...)</code>，两种函数定义方式适用于不同的场景</p> <h4 id=main>main函数形式<a class=headerlink href=#main title="Permanent link">&para;</a></h4> <p>使用此方式，一个函数定义的例子如下：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=kt>int</span><span class=w> </span><span class=nf>func</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>argc</span><span class=p>,</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>argv</span><span class=p>[])</span>
<a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a><span class=p>{</span>
<a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a><span class=w>    </span><span class=n>printf</span><span class=p>(</span><span class=s>&quot;%dparameter(s)</span><span class=se>\r\n</span><span class=s>&quot;</span><span class=p>,</span><span class=w> </span><span class=n>argc</span><span class=p>);</span>
<a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>char</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>argc</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
<a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a><span class=w>    </span><span class=p>{</span>
<a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a><span class=w>        </span><span class=n>printf</span><span class=p>(</span><span class=s>&quot;%s</span><span class=se>\r\n</span><span class=s>&quot;</span><span class=p>,</span><span class=w> </span><span class=n>argv</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
<a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a><span class=p>}</span>
<a id=__codelineno-6-9 name=__codelineno-6-9 href=#__codelineno-6-9></a><span class=n>SHELL_EXPORT_CMD</span><span class=p>(</span><span class=n>SHELL_CMD_PERMISSION</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>|</span><span class=n>SHELL_CMD_TYPE</span><span class=p>(</span><span class=n>SHELL_TYPE_CMD_MAIN</span><span class=p>),</span><span class=w> </span><span class=n>func</span><span class=p>,</span><span class=w> </span><span class=n>func</span><span class=p>,</span><span class=w> </span><span class=n>test</span><span class=p>);</span>
</code></pre></div> <p>终端调用</p> <div class=highlight><pre><span></span><code><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a>letter:/$<span class=w> </span>func<span class=w> </span><span class=s2>&quot;hello world&quot;</span>
<a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a><span class=m>2</span><span class=w> </span>parameter<span class=o>(</span>s<span class=o>)</span>
<a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a>hello<span class=w> </span>world
</code></pre></div> <h4 id=c>普通C函数形式<a class=headerlink href=#c title="Permanent link">&para;</a></h4> <p>使用此方式，shell会自动对参数进行转化处理，目前支持二进制，八进制，十进制，十六进制整形，字符，字符串的自动处理，如果需要其他类型的参数，请使用代理参数解析的方式(参考<a href=#代理函数和代理参数解析>代理函数和代理参数解析</a>)，或者使用字符串的方式作为参数，自行进行处理，例子如下：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=kt>int</span><span class=w> </span><span class=nf>func</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=p>,</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=n>ch</span><span class=p>,</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>str</span><span class=p>)</span>
<a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a><span class=p>{</span>
<a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a><span class=w>    </span><span class=n>printf</span><span class=p>(</span><span class=s>&quot;input int: %d, char: %c, string: %s</span><span class=se>\r\n</span><span class=s>&quot;</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>,</span><span class=w> </span><span class=n>ch</span><span class=p>,</span><span class=w> </span><span class=n>str</span><span class=p>);</span>
<a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a><span class=p>}</span>
<a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a><span class=n>SHELL_EXPORT_CMD</span><span class=p>(</span><span class=n>SHELL_CMD_PERMISSION</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>|</span><span class=n>SHELL_CMD_TYPE</span><span class=p>(</span><span class=n>SHELL_TYPE_CMD_FUNC</span><span class=p>),</span><span class=w> </span><span class=n>func</span><span class=p>,</span><span class=w> </span><span class=n>func</span><span class=p>,</span><span class=w> </span><span class=n>test</span><span class=p>);</span>
</code></pre></div> <p>终端调用</p> <div class=highlight><pre><span></span><code><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a>letter:/$<span class=w> </span>func<span class=w> </span><span class=m>666</span><span class=w> </span><span class=s1>&#39;A&#39;</span><span class=w> </span><span class=s2>&quot;hello world&quot;</span>
<a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a>input<span class=w> </span>int:<span class=w> </span><span class=m>666</span>,<span class=w> </span>char:<span class=w> </span>A,<span class=w> </span>string:<span class=w> </span>hello<span class=w> </span>world
</code></pre></div> <h3 id=_6>变量使用<a class=headerlink href=#_6 title="Permanent link">&para;</a></h3> <p>letter shell 3.x支持导出变量，通过命令行查看，设置以及使用变量的值</p> <ul> <li> <p>导出变量</p> <p>变量导出使用<code>SHELL_EXPORT_VAR</code>宏，支持整形(char, short, int)，字符串，指针以及节点变量，变量导出需要使用引用的方式，如果不允许对变量进行修改，在属性中添加<code>SHELL_CMD_READ_ONLY</code></p> <div class=highlight><pre><span></span><code><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a><span class=kt>int</span><span class=w> </span><span class=n>varInt</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
<a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a><span class=n>SHELL_EXPORT_VAR</span><span class=p>(</span><span class=n>SHELL_CMD_PERMISSION</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>|</span><span class=n>SHELL_CMD_TYPE</span><span class=p>(</span><span class=n>SHELL_TYPE_VAR_INT</span><span class=p>),</span><span class=w> </span><span class=n>varInt</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>varInt</span><span class=p>,</span><span class=w> </span><span class=n>test</span><span class=p>);</span>
<a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a>
<a id=__codelineno-10-4 name=__codelineno-10-4 href=#__codelineno-10-4></a><span class=kt>char</span><span class=w> </span><span class=n>str</span><span class=p>[]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;test string&quot;</span><span class=p>;</span>
<a id=__codelineno-10-5 name=__codelineno-10-5 href=#__codelineno-10-5></a><span class=n>SHELL_EXPORT_VAR</span><span class=p>(</span><span class=n>SHELL_CMD_PERMISSION</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>|</span><span class=n>SHELL_CMD_TYPE</span><span class=p>(</span><span class=n>SHELL_TYPE_VAR_STRING</span><span class=p>),</span><span class=w> </span><span class=n>varStr</span><span class=p>,</span><span class=w> </span><span class=n>str</span><span class=p>,</span><span class=w> </span><span class=n>test</span><span class=p>);</span>
<a id=__codelineno-10-6 name=__codelineno-10-6 href=#__codelineno-10-6></a>
<a id=__codelineno-10-7 name=__codelineno-10-7 href=#__codelineno-10-7></a><span class=n>Log</span><span class=w> </span><span class=n>log</span><span class=p>;</span>
<a id=__codelineno-10-8 name=__codelineno-10-8 href=#__codelineno-10-8></a><span class=n>SHELL_EXPORT_VAR</span><span class=p>(</span><span class=n>SHELL_CMD_PERMISSION</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>|</span><span class=n>SHELL_CMD_TYPE</span><span class=p>(</span><span class=n>SHELL_TYPE_VAR_POINT</span><span class=p>),</span><span class=w> </span><span class=n>log</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>log</span><span class=p>,</span><span class=w> </span><span class=n>test</span><span class=p>);</span>
</code></pre></div> </li> <li> <p>查看变量</p> <p>在命令行直接输入导出的变量名即可查看变量当前的值</p> <div class=highlight><pre><span></span><code><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a>letter:/$<span class=w> </span>varInt
<a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a><span class=nv>varInt</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=m>0</span>,<span class=w> </span>0x00000000
<a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a>
<a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a>letter:/$<span class=w> </span>varStr
<a id=__codelineno-11-5 name=__codelineno-11-5 href=#__codelineno-11-5></a><span class=nv>varStr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;test string&quot;</span>
</code></pre></div> </li> <li> <p>修改变量</p> <p>使用<code>setVar</code>命令修改变量的值，对于字符串型变量，请确认字符串有分配足够的空间，指针类型的变量不可修改</p> <div class=highlight><pre><span></span><code><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a>letter:/$<span class=w> </span>setVar<span class=w> </span>varInt<span class=w> </span><span class=m>45678</span>
<a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a><span class=nv>varInt</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=m>45678</span>,<span class=w> </span>0x0000b26e
<a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a>
<a id=__codelineno-12-4 name=__codelineno-12-4 href=#__codelineno-12-4></a>letter:/$<span class=w> </span>setVar<span class=w> </span>varStr<span class=w> </span><span class=s2>&quot;hello&quot;</span>
<a id=__codelineno-12-5 name=__codelineno-12-5 href=#__codelineno-12-5></a><span class=nv>varStr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;hello&quot;</span>
</code></pre></div> </li> <li> <p>使用变量</p> <p>letter shell 3.x的变量可以在命令中作为参数传递，对于需要传递结构体引用到命令中的场景特别适用，使用<code>$</code>+变量名的方式传递</p> <div class=highlight><pre><span></span><code><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a>letter:/$<span class=w> </span>shellPrint<span class=w> </span><span class=nv>$shell</span><span class=w> </span><span class=s2>&quot;hello world\r\n&quot;</span>
<a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a>hello<span class=w> </span>world
</code></pre></div> </li> </ul> <h3 id=shell>在函数中获取当前shell对象<a class=headerlink href=#shell title="Permanent link">&para;</a></h3> <p>letter shell采取一个静态数组对定义的多个shell进行管理，shell数量可以修改宏<code>SHELL_MAX_NUMBER</code>定义(为了不使用动态内存分配，此处通过数据进行管理)，从而，在shell执行的函数中，可以调用<code>shellGetCurrent()</code>获得当前活动的shell对象，从而可以实现某一个函数在不同的shell对象中发生不同的行为，也可以通过这种方式获得shell对象后，调用<code>shellWriteString(shell, string)</code>进行shell的输出</p> <h3 id=_7>执行未导出函数<a class=headerlink href=#_7 title="Permanent link">&para;</a></h3> <p>letter shell支持通过函数地址直接执行函数，可以方便执行那些没有导出，但是又临时需要使用的函数，使用命令<code>exec [addr] [args]</code>执行，使用此功能需要开启<code>SHELL_EXEC_UNDEF_FUNC</code>宏，注意，由于直接操作函数地址执行，如果给进的地址有误，可能引起程序崩溃</p> <p>函数的地址可以通过编译生成的文件查找，比如说对于keil，可以在<code>.map</code>文件中查找到每个函数的地址，但是要注意有些平台可能需要要对地址做进一步处理，比如说对于 arm 平台，如果使用的是 Thumb 指令集，那么需要将地址的最低位置 1，比如说<code>shellClear</code>函数地址为<code>0x08028620</code>，则通过<code>exec</code>执行应为<code>exec 0x08028621</code></p> <p>其他编译器查找函数地址的方式和地址偏移的处理，请参考各编译器手册</p> <h2 id=_8>命令定义<a class=headerlink href=#_8 title="Permanent link">&para;</a></h2> <p>letter shell 3.x将可执行的函数命令定义，用户定义，按键定义以及变量定义统一归为命令定义，使用相同的结构储存，查找和执行</p> <h3 id=_9>定义方式<a class=headerlink href=#_9 title="Permanent link">&para;</a></h3> <p>letter shell 支持使用命令导出方式和命令表方式进行命令的添加，定义，通过宏<code>SHELL_USING_CMD_EXPORT</code>控制</p> <p>命令导出方式支持keil，IAR以及GCC</p> <ol> <li> <p>命令导出方式</p> <p>letter shell 支持在函数体外部，采用定义常量的方式定义命令，例如<code>SHELL_EXPORT_CMD(SHELL_CMD_PERMISSION(0)|SHELL_CMD_TYPE (SHELL_TYPE_CMD_MAIN)|SHELL_CMD_DISABLE_RETURN,help, shellHelp, show command info\r\nhelp [cmd]);</code></p> <p>对于使用keil进行编译，需要在keil的target option中增加--keep shellCommand*，防止定义的命令被优化掉</p> <p>使用GCC编译时，需要在ld文件中的只读数据区(建议)添加：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a>_shell_command_start = .;
<a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a>KEEP (*(shellCommand))
<a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a>_shell_command_end = .;
</code></pre></div> </li> <li> <p>命令表方式</p> <ul> <li> <p>当使用其他暂时不支持使用命令导出方式的编译器时，需要在<code>shell_cmd_list.c</code>文件的命令表中添加</p> <div class=highlight><pre><span></span><code><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a><span class=k>const</span><span class=w> </span><span class=n>SHELL_CommandTypeDef</span><span class=w> </span><span class=n>shellDefaultCommandList</span><span class=p>[]</span><span class=w> </span><span class=o>=</span>
<a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a><span class=p>{</span>
<a id=__codelineno-15-3 name=__codelineno-15-3 href=#__codelineno-15-3></a><span class=w>    </span><span class=n>SHELL_CMD_ITEM</span><span class=p>(</span>
<a id=__codelineno-15-4 name=__codelineno-15-4 href=#__codelineno-15-4></a><span class=w>               </span><span class=n>SHELL_CMD_PERMISSION</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>|</span><span class=n>SHELL_CMD_TYPE</span><span class=p>(</span><span class=n>SHELL_TYPE_CMD_MAIN</span><span class=p>)</span><span class=o>|</span><span class=n>SHELL_CMD_DISABLE_RETURN</span><span class=p>,</span>
<a id=__codelineno-15-5 name=__codelineno-15-5 href=#__codelineno-15-5></a><span class=w>               </span><span class=n>help</span><span class=p>,</span><span class=w> </span><span class=n>shellHelp</span><span class=p>,</span><span class=w> </span><span class=n>show</span><span class=w> </span><span class=n>command</span><span class=w> </span><span class=n>info</span><span class=err>\</span><span class=n>r</span><span class=err>\</span><span class=n>nhelp</span><span class=w> </span><span class=p>[</span><span class=n>cmd</span><span class=p>]),</span>
<a id=__codelineno-15-6 name=__codelineno-15-6 href=#__codelineno-15-6></a><span class=p>};</span>
</code></pre></div> </li> </ul> </li> </ol> <h3 id=_10>定义宏说明<a class=headerlink href=#_10 title="Permanent link">&para;</a></h3> <p>letter shell 3.x对可执行命令，按键，用户以及变量分别提供了一个宏，用于进行命令定义</p> <ol> <li> <p>可执行命令定义</p> <p>使用宏<code>SHELL_EXPORT_CMD</code>定义可执行命令，定义如下</p> <div class=highlight><pre><span></span><code><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a><span class=cm>/**</span>
<a id=__codelineno-16-2 name=__codelineno-16-2 href=#__codelineno-16-2></a><span class=cm> * @brief shell 命令定义</span>
<a id=__codelineno-16-3 name=__codelineno-16-3 href=#__codelineno-16-3></a><span class=cm> *</span>
<a id=__codelineno-16-4 name=__codelineno-16-4 href=#__codelineno-16-4></a><span class=cm> * @param _attr 命令属性</span>
<a id=__codelineno-16-5 name=__codelineno-16-5 href=#__codelineno-16-5></a><span class=cm> * @param _name 命令名</span>
<a id=__codelineno-16-6 name=__codelineno-16-6 href=#__codelineno-16-6></a><span class=cm> * @param _func 命令函数</span>
<a id=__codelineno-16-7 name=__codelineno-16-7 href=#__codelineno-16-7></a><span class=cm> * @param _desc 命令描述</span>
<a id=__codelineno-16-8 name=__codelineno-16-8 href=#__codelineno-16-8></a><span class=cm> */</span>
<a id=__codelineno-16-9 name=__codelineno-16-9 href=#__codelineno-16-9></a><span class=cp>#define SHELL_EXPORT_CMD(_attr, _name, _func, _desc) \</span>
<a id=__codelineno-16-10 name=__codelineno-16-10 href=#__codelineno-16-10></a><span class=cp>        const char shellCmd##_name[] = #_name; \</span>
<a id=__codelineno-16-11 name=__codelineno-16-11 href=#__codelineno-16-11></a><span class=cp>        const char shellDesc##_name[] = #_desc; \</span>
<a id=__codelineno-16-12 name=__codelineno-16-12 href=#__codelineno-16-12></a><span class=cp>        SHELL_USED const ShellCommand \</span>
<a id=__codelineno-16-13 name=__codelineno-16-13 href=#__codelineno-16-13></a><span class=cp>        shellCommand##_name SHELL_SECTION(&quot;shellCommand&quot;) =  \</span>
<a id=__codelineno-16-14 name=__codelineno-16-14 href=#__codelineno-16-14></a><span class=cp>        { \</span>
<a id=__codelineno-16-15 name=__codelineno-16-15 href=#__codelineno-16-15></a><span class=cp>            .attr.value = _attr, \</span>
<a id=__codelineno-16-16 name=__codelineno-16-16 href=#__codelineno-16-16></a><span class=cp>            .data.cmd.name = shellCmd##_name, \</span>
<a id=__codelineno-16-17 name=__codelineno-16-17 href=#__codelineno-16-17></a><span class=cp>            .data.cmd.function = (int (*)())_func, \</span>
<a id=__codelineno-16-18 name=__codelineno-16-18 href=#__codelineno-16-18></a><span class=cp>            .data.cmd.desc = shellDesc##_name \</span>
<a id=__codelineno-16-19 name=__codelineno-16-19 href=#__codelineno-16-19></a><span class=cp>        }</span>
</code></pre></div> </li> <li> <p>变量定义</p> <p>使用宏<code>SHELL_EXPORT_VAR</code>定义变量，定义如下</p> <div class=highlight><pre><span></span><code><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a><span class=cm>/**</span>
<a id=__codelineno-17-2 name=__codelineno-17-2 href=#__codelineno-17-2></a><span class=cm> * @brief shell 变量定义</span>
<a id=__codelineno-17-3 name=__codelineno-17-3 href=#__codelineno-17-3></a><span class=cm> *</span>
<a id=__codelineno-17-4 name=__codelineno-17-4 href=#__codelineno-17-4></a><span class=cm> * @param _attr 变量属性</span>
<a id=__codelineno-17-5 name=__codelineno-17-5 href=#__codelineno-17-5></a><span class=cm> * @param _name 变量名</span>
<a id=__codelineno-17-6 name=__codelineno-17-6 href=#__codelineno-17-6></a><span class=cm> * @param _value 变量值</span>
<a id=__codelineno-17-7 name=__codelineno-17-7 href=#__codelineno-17-7></a><span class=cm> * @param _desc 变量描述</span>
<a id=__codelineno-17-8 name=__codelineno-17-8 href=#__codelineno-17-8></a><span class=cm> */</span>
<a id=__codelineno-17-9 name=__codelineno-17-9 href=#__codelineno-17-9></a><span class=cp>#define SHELL_EXPORT_VAR(_attr, _name, _value, _desc) \</span>
<a id=__codelineno-17-10 name=__codelineno-17-10 href=#__codelineno-17-10></a><span class=cp>        const char shellCmd##_name[] = #_name; \</span>
<a id=__codelineno-17-11 name=__codelineno-17-11 href=#__codelineno-17-11></a><span class=cp>        const char shellDesc##_name[] = #_desc; \</span>
<a id=__codelineno-17-12 name=__codelineno-17-12 href=#__codelineno-17-12></a><span class=cp>        SHELL_USED const ShellCommand \</span>
<a id=__codelineno-17-13 name=__codelineno-17-13 href=#__codelineno-17-13></a><span class=cp>        shellVar##_name SHELL_SECTION(&quot;shellCommand&quot;) =  \</span>
<a id=__codelineno-17-14 name=__codelineno-17-14 href=#__codelineno-17-14></a><span class=cp>        { \</span>
<a id=__codelineno-17-15 name=__codelineno-17-15 href=#__codelineno-17-15></a><span class=cp>            .attr.value = _attr, \</span>
<a id=__codelineno-17-16 name=__codelineno-17-16 href=#__codelineno-17-16></a><span class=cp>            .data.var.name = shellCmd##_name, \</span>
<a id=__codelineno-17-17 name=__codelineno-17-17 href=#__codelineno-17-17></a><span class=cp>            .data.var.value = (void *)_value, \</span>
<a id=__codelineno-17-18 name=__codelineno-17-18 href=#__codelineno-17-18></a><span class=cp>            .data.var.desc = shellDesc##_name \</span>
<a id=__codelineno-17-19 name=__codelineno-17-19 href=#__codelineno-17-19></a><span class=cp>        }</span>
</code></pre></div> <p>变量定义时，<code>_value</code>应该是变量的引用，如果变量不允许修改，则需要在增加<code>SHELL_CMD_READ_ONLY</code>属性</p> </li> <li> <p>用户定义</p> <p>使用宏<code>SHELL_EXPORT_USER</code>定义用户，定义如下</p> <div class=highlight><pre><span></span><code><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a><span class=cm>/**</span>
<a id=__codelineno-18-2 name=__codelineno-18-2 href=#__codelineno-18-2></a><span class=cm> * @brief shell 用户定义</span>
<a id=__codelineno-18-3 name=__codelineno-18-3 href=#__codelineno-18-3></a><span class=cm> *</span>
<a id=__codelineno-18-4 name=__codelineno-18-4 href=#__codelineno-18-4></a><span class=cm> * @param _attr 用户属性</span>
<a id=__codelineno-18-5 name=__codelineno-18-5 href=#__codelineno-18-5></a><span class=cm> * @param _name 用户名</span>
<a id=__codelineno-18-6 name=__codelineno-18-6 href=#__codelineno-18-6></a><span class=cm> * @param _password 用户密码</span>
<a id=__codelineno-18-7 name=__codelineno-18-7 href=#__codelineno-18-7></a><span class=cm> * @param _desc 用户描述</span>
<a id=__codelineno-18-8 name=__codelineno-18-8 href=#__codelineno-18-8></a><span class=cm> */</span>
<a id=__codelineno-18-9 name=__codelineno-18-9 href=#__codelineno-18-9></a><span class=cp>#define SHELL_EXPORT_USER(_attr, _name, _password, _desc) \</span>
<a id=__codelineno-18-10 name=__codelineno-18-10 href=#__codelineno-18-10></a><span class=cp>        const char shellCmd##_name[] = #_name; \</span>
<a id=__codelineno-18-11 name=__codelineno-18-11 href=#__codelineno-18-11></a><span class=cp>        const char shellPassword##_name[] = #_password; \</span>
<a id=__codelineno-18-12 name=__codelineno-18-12 href=#__codelineno-18-12></a><span class=cp>        const char shellDesc##_name[] = #_desc; \</span>
<a id=__codelineno-18-13 name=__codelineno-18-13 href=#__codelineno-18-13></a><span class=cp>        SHELL_USED const ShellCommand \</span>
<a id=__codelineno-18-14 name=__codelineno-18-14 href=#__codelineno-18-14></a><span class=cp>        shellUser##_name SHELL_SECTION(&quot;shellCommand&quot;) =  \</span>
<a id=__codelineno-18-15 name=__codelineno-18-15 href=#__codelineno-18-15></a><span class=cp>        { \</span>
<a id=__codelineno-18-16 name=__codelineno-18-16 href=#__codelineno-18-16></a><span class=cp>            .attr.value = _attr|SHELL_CMD_TYPE(SHELL_TYPE_USER), \</span>
<a id=__codelineno-18-17 name=__codelineno-18-17 href=#__codelineno-18-17></a><span class=cp>            .data.user.name = shellCmd##_name, \</span>
<a id=__codelineno-18-18 name=__codelineno-18-18 href=#__codelineno-18-18></a><span class=cp>            .data.user.password = shellPassword##_name, \</span>
<a id=__codelineno-18-19 name=__codelineno-18-19 href=#__codelineno-18-19></a><span class=cp>            .data.user.desc = shellDesc##_name \</span>
<a id=__codelineno-18-20 name=__codelineno-18-20 href=#__codelineno-18-20></a><span class=cp>        }</span>
</code></pre></div> </li> <li> <p>按键定义</p> <p>使用宏<code>SHELL_EXPORT_KEY</code>定义按键，定义如下</p> <div class=highlight><pre><span></span><code><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a><span class=cm>/**</span>
<a id=__codelineno-19-2 name=__codelineno-19-2 href=#__codelineno-19-2></a><span class=cm> * @brief shell 按键定义</span>
<a id=__codelineno-19-3 name=__codelineno-19-3 href=#__codelineno-19-3></a><span class=cm> *</span>
<a id=__codelineno-19-4 name=__codelineno-19-4 href=#__codelineno-19-4></a><span class=cm> * @param _attr 按键属性</span>
<a id=__codelineno-19-5 name=__codelineno-19-5 href=#__codelineno-19-5></a><span class=cm> * @param _value 按键键值</span>
<a id=__codelineno-19-6 name=__codelineno-19-6 href=#__codelineno-19-6></a><span class=cm> * @param _func 按键函数</span>
<a id=__codelineno-19-7 name=__codelineno-19-7 href=#__codelineno-19-7></a><span class=cm> * @param _desc 按键描述</span>
<a id=__codelineno-19-8 name=__codelineno-19-8 href=#__codelineno-19-8></a><span class=cm> */</span>
<a id=__codelineno-19-9 name=__codelineno-19-9 href=#__codelineno-19-9></a><span class=cp>#define SHELL_EXPORT_KEY(_attr, _value, _func, _desc) \</span>
<a id=__codelineno-19-10 name=__codelineno-19-10 href=#__codelineno-19-10></a><span class=cp>        const char shellDesc##_value[] = #_desc; \</span>
<a id=__codelineno-19-11 name=__codelineno-19-11 href=#__codelineno-19-11></a><span class=cp>        SHELL_USED const ShellCommand \</span>
<a id=__codelineno-19-12 name=__codelineno-19-12 href=#__codelineno-19-12></a><span class=cp>        shellKey##_value SHELL_SECTION(&quot;shellCommand&quot;) =  \</span>
<a id=__codelineno-19-13 name=__codelineno-19-13 href=#__codelineno-19-13></a><span class=cp>        { \</span>
<a id=__codelineno-19-14 name=__codelineno-19-14 href=#__codelineno-19-14></a><span class=cp>            .attr.value = _attr|SHELL_CMD_TYPE(SHELL_TYPE_KEY), \</span>
<a id=__codelineno-19-15 name=__codelineno-19-15 href=#__codelineno-19-15></a><span class=cp>            .data.key.value = _value, \</span>
<a id=__codelineno-19-16 name=__codelineno-19-16 href=#__codelineno-19-16></a><span class=cp>            .data.key.function = (void (*)(Shell *))_func, \</span>
<a id=__codelineno-19-17 name=__codelineno-19-17 href=#__codelineno-19-17></a><span class=cp>            .data.key.desc = shellDesc##_value \</span>
<a id=__codelineno-19-18 name=__codelineno-19-18 href=#__codelineno-19-18></a><span class=cp>        }</span>
</code></pre></div> <p>按键键值为在终端输入按键会发送的字符串序列，以大端模式表示，比如在SecureCRT中断，按下Tab键，会发送0x0B，则这个按键的键值为0x0B000000，如果按下方向上，会依次发送0x1B, 0x5B, 0x41, 则这个键的键值为0x1B5B4100</p> </li> </ol> <h3 id=_11>命令属性字段说明<a class=headerlink href=#_11 title="Permanent link">&para;</a></h3> <p>在命令定义中，有一个<code>attr</code>字段，表示该命令的属性，具体定义为</p> <div class=highlight><pre><span></span><code><a id=__codelineno-20-1 name=__codelineno-20-1 href=#__codelineno-20-1></a><span class=k>union</span>
<a id=__codelineno-20-2 name=__codelineno-20-2 href=#__codelineno-20-2></a><span class=p>{</span>
<a id=__codelineno-20-3 name=__codelineno-20-3 href=#__codelineno-20-3></a><span class=w>    </span><span class=k>struct</span>
<a id=__codelineno-20-4 name=__codelineno-20-4 href=#__codelineno-20-4></a><span class=w>    </span><span class=p>{</span>
<a id=__codelineno-20-5 name=__codelineno-20-5 href=#__codelineno-20-5></a><span class=w>        </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=n>permission</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=mi>8</span><span class=p>;</span><span class=w>                       </span><span class=cm>/**&lt; command权限 */</span>
<a id=__codelineno-20-6 name=__codelineno-20-6 href=#__codelineno-20-6></a><span class=w>        </span><span class=n>ShellCommandType</span><span class=w> </span><span class=n>type</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=mi>4</span><span class=p>;</span><span class=w>                          </span><span class=cm>/**&lt; command类型 */</span>
<a id=__codelineno-20-7 name=__codelineno-20-7 href=#__codelineno-20-7></a><span class=w>        </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=n>enableUnchecked</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>                  </span><span class=cm>/**&lt; 在未校验密码的情况下可用 */</span>
<a id=__codelineno-20-8 name=__codelineno-20-8 href=#__codelineno-20-8></a><span class=w>        </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>char</span><span class=w>  </span><span class=n>readOnly</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>                        </span><span class=cm>/**&lt; 只读 */</span>
<a id=__codelineno-20-9 name=__codelineno-20-9 href=#__codelineno-20-9></a><span class=w>        </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=n>reserve</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>                          </span><span class=cm>/**&lt; 保留 */</span>
<a id=__codelineno-20-10 name=__codelineno-20-10 href=#__codelineno-20-10></a><span class=w>        </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=n>paramNum</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=mi>4</span><span class=p>;</span><span class=w>                         </span><span class=cm>/**&lt; 参数数量 */</span>
<a id=__codelineno-20-11 name=__codelineno-20-11 href=#__codelineno-20-11></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=n>attrs</span><span class=p>;</span>
<a id=__codelineno-20-12 name=__codelineno-20-12 href=#__codelineno-20-12></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>value</span><span class=p>;</span>
<a id=__codelineno-20-13 name=__codelineno-20-13 href=#__codelineno-20-13></a><span class=p>}</span><span class=w> </span><span class=n>attr</span><span class=p>;</span>
</code></pre></div> <p>在定义命令时，需要给定这些值，可以通过宏<code>SHELL_CMD_PERMISSION(permission)</code>, <code>SHELL_CMD_TYPE(type)</code>, <code>SHELL_CMD_ENABLE_UNCHECKED</code>, <code>SHELL_CMD_DISABLE_RETURN</code>, <code>SHELL_CMD_READ_ONLY</code>, <code>SHELL_CMD_PARAM_NUM(num)</code>快速声明</p> <h2 id=_12>代理函数和代理参数解析<a class=headerlink href=#_12 title="Permanent link">&para;</a></h2> <p>letter shell 3.x原生支持将整数，字符，字符串参数，以及在某些情况下的浮点参数直接传递给执行命令的函数，一般情况下，这几种参数类型完全可以满足调试需要，然而在某些情况下，用户确实需要传递其他类型的参数，此时，可以选择将命令定义成main函数形式，使用字符串传递参数，然后自行对参数进行解析，除此之外，letter shell还提供了代理函数的机制，可以对任意类型的参数进行自定义解析</p> <p>关于代理函数的实现原理和具体使用示例，可以参考<a href=https://nevermindzzt.github.io/2020/04/17/letter-shell%E4%BB%A3%E7%90%86%E5%87%BD%E6%95%B0%E8%A7%A3%E6%9E%90/ >letter-shell代理函数解析</a></p> <p>使用代理函数，用户需要自定义代理参数解析器，即一个将基本参数(整数，字符，字符串参数)转换成目标类型参数的函数或者宏，letter shell默认实现了浮点类型的参数解析器<code>SHELL_PARAM_FLOAT(x)</code></p> <p>然后，使用代理函数命令导出宏定义命令，比如需要需要传递多个浮点参数的函数，如下</p> <div class=highlight><pre><span></span><code><a id=__codelineno-21-1 name=__codelineno-21-1 href=#__codelineno-21-1></a><span class=kt>void</span><span class=w> </span><span class=nf>test</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>a</span><span class=p>,</span><span class=w> </span><span class=kt>float</span><span class=w> </span><span class=n>b</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>c</span><span class=p>,</span><span class=w> </span><span class=kt>float</span><span class=w> </span><span class=n>d</span><span class=p>)</span>
<a id=__codelineno-21-2 name=__codelineno-21-2 href=#__codelineno-21-2></a><span class=p>{</span>
<a id=__codelineno-21-3 name=__codelineno-21-3 href=#__codelineno-21-3></a><span class=w>    </span><span class=n>printf</span><span class=p>(</span><span class=s>&quot;%d, %f, %d, %f </span><span class=se>\r\n</span><span class=s>&quot;</span><span class=p>,</span><span class=w> </span><span class=n>a</span><span class=p>,</span><span class=w> </span><span class=n>b</span><span class=p>,</span><span class=w> </span><span class=n>c</span><span class=p>,</span><span class=w> </span><span class=n>d</span><span class=p>);</span>
<a id=__codelineno-21-4 name=__codelineno-21-4 href=#__codelineno-21-4></a><span class=p>}</span>
<a id=__codelineno-21-5 name=__codelineno-21-5 href=#__codelineno-21-5></a><span class=n>SHELL_EXPORT_CMD_AGENCY</span><span class=p>(</span><span class=n>SHELL_CMD_TYPE</span><span class=p>(</span><span class=n>SHELL_TYPE_CMD_FUNC</span><span class=p>),</span>
<a id=__codelineno-21-6 name=__codelineno-21-6 href=#__codelineno-21-6></a><span class=n>test</span><span class=p>,</span><span class=w> </span><span class=n>test</span><span class=p>,</span><span class=w> </span><span class=n>test</span><span class=p>,</span>
<a id=__codelineno-21-7 name=__codelineno-21-7 href=#__codelineno-21-7></a><span class=n>p1</span><span class=p>,</span><span class=w> </span><span class=n>SHELL_PARAM_FLOAT</span><span class=p>(</span><span class=n>p2</span><span class=p>),</span><span class=w> </span><span class=n>p3</span><span class=p>,</span><span class=w> </span><span class=n>SHELL_PARAM_FLOAT</span><span class=p>(</span><span class=n>p4</span><span class=p>));</span>
</code></pre></div> <p>相比常规的命令导出，代理函数命令导出前4个参数和常规形式的命令导出一致，之后的参数即传递至目标函数的参数，letter shell默认实现的代理函数定义支持最多7个参数，p1~p7，对于不需要代理参数解析的参数，只需要对应写入<code>px(x为1~7)</code>即可，比如上方示例的<code>p1</code>和<code>p3</code>，而需要代理参数解析的参数，则需要使用对应的参数解析器，比如上方示例的<code>p2</code>和<code>p4</code></p> <h2 id=_13>函数签名<a class=headerlink href=#_13 title="Permanent link">&para;</a></h2> <p>letter shell 3.2.x 之后，引入了函数签名的概念，以便于参数自动解析</p> <p>之前的版本里，如果声明的命令是 <code>SHELL_TYPE_CMD_FUNC</code>，shell 会自动进行参数的转换，但是参数转换后的类型是猜出来的，无法保证转换后的数据类型是正确的，一旦猜错了，就容易导致程序挂掉</p> <p>由此，借鉴 Java 等语言的函数签名，新版也引入了函数签名的概念，在声明命令时，可以给定最终执行命令的函数的签名，shell 根据这个签名进行参数转换，使用此功能时，需要打开宏 <code>SHELL_USING_FUNC_SIGNATURE</code></p> <p>函数签名是一个字符串，通过这个字符串声明表达函数的参数类型，返回值不声明，比如一个函数<code>int func(int a, char *b, char c)</code>，它的函数签名就是 <code>isc</code></p> <p>基本类型的参数签名定义如下:</p> <table> <thead> <tr> <th>类型</th> <th>签名</th> </tr> </thead> <tbody> <tr> <td>char(字符)</td> <td>c</td> </tr> <tr> <td>char(数字)</td> <td>q</td> </tr> <tr> <td>short(数字)</td> <td>h</td> </tr> <tr> <td>int(数字)</td> <td>i</td> </tr> <tr> <td>char * (字符串)</td> <td>s</td> </tr> <tr> <td>pointer</td> <td>p</td> </tr> </tbody> </table> <p>声明命令时，在最后添加一个参数 <code>.data.cmd.signature = "isc"</code> 即可，比如：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-22-1 name=__codelineno-22-1 href=#__codelineno-22-1></a><span class=kt>void</span><span class=w> </span><span class=nf>shellFuncSignatureTest</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>a</span><span class=p>,</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>b</span><span class=p>,</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=n>c</span><span class=p>)</span>
<a id=__codelineno-22-2 name=__codelineno-22-2 href=#__codelineno-22-2></a><span class=p>{</span>
<a id=__codelineno-22-3 name=__codelineno-22-3 href=#__codelineno-22-3></a><span class=w>    </span><span class=n>printf</span><span class=p>(</span><span class=s>&quot;a = %d, b = %s, c = %c</span><span class=se>\r\n</span><span class=s>&quot;</span><span class=p>,</span><span class=w> </span><span class=n>a</span><span class=p>,</span><span class=w> </span><span class=n>b</span><span class=p>,</span><span class=w> </span><span class=n>c</span><span class=p>);</span>
<a id=__codelineno-22-4 name=__codelineno-22-4 href=#__codelineno-22-4></a><span class=p>}</span>
<a id=__codelineno-22-5 name=__codelineno-22-5 href=#__codelineno-22-5></a><span class=n>SHELL_EXPORT_CMD</span><span class=p>(</span><span class=n>SHELL_CMD_PERMISSION</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>|</span><span class=n>SHELL_CMD_TYPE</span><span class=p>(</span><span class=n>SHELL_TYPE_CMD_FUNC</span><span class=p>),</span>
<a id=__codelineno-22-6 name=__codelineno-22-6 href=#__codelineno-22-6></a><span class=n>funcSignatureTest</span><span class=p>,</span><span class=w> </span><span class=n>shellFuncSignatureTest</span><span class=p>,</span><span class=w> </span><span class=n>test</span><span class=w> </span><span class=n>function</span><span class=w> </span><span class=n>signature</span><span class=p>,</span><span class=w> </span><span class=p>.</span><span class=n>data</span><span class=p>.</span><span class=n>cmd</span><span class=p>.</span><span class=n>signature</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;isc&quot;</span><span class=p>);</span>
</code></pre></div> <h3 id=_14>自定义类型解析<a class=headerlink href=#_14 title="Permanent link">&para;</a></h3> <p>由于函数签名的引用，我们就可以使用函数签名描述任何参数，对应的，在参数类型已知的情况下，也可以定义对应的参数解析器进行参数解析，自定义的参数类型签名需要以 <code>L</code> 开头，以 <code>;</code> 结尾，比如说定义一个 <code>TestStruct</code> 结构体类型为 <code>LTestStruct;</code>，那么接收这个结构体为参数的函数就可以通过这个类型签名定义函数签名，并导出命令</p> <div class=highlight><pre><span></span><code><a id=__codelineno-23-1 name=__codelineno-23-1 href=#__codelineno-23-1></a><span class=k>typedef</span><span class=w> </span><span class=k>struct</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-23-2 name=__codelineno-23-2 href=#__codelineno-23-2></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>a</span><span class=p>;</span>
<a id=__codelineno-23-3 name=__codelineno-23-3 href=#__codelineno-23-3></a><span class=w>    </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>b</span><span class=p>;</span>
<a id=__codelineno-23-4 name=__codelineno-23-4 href=#__codelineno-23-4></a><span class=p>}</span><span class=w> </span><span class=n>TestStruct</span><span class=p>;</span>
<a id=__codelineno-23-5 name=__codelineno-23-5 href=#__codelineno-23-5></a>
<a id=__codelineno-23-6 name=__codelineno-23-6 href=#__codelineno-23-6></a><span class=kt>void</span><span class=w> </span><span class=nf>shellParamParserTest</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>a</span><span class=p>,</span><span class=w> </span><span class=n>TestStruct</span><span class=w> </span><span class=o>*</span><span class=n>data</span><span class=p>,</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>c</span><span class=p>)</span>
<a id=__codelineno-23-7 name=__codelineno-23-7 href=#__codelineno-23-7></a><span class=p>{</span>
<a id=__codelineno-23-8 name=__codelineno-23-8 href=#__codelineno-23-8></a><span class=w>    </span><span class=n>printf</span><span class=p>(</span><span class=s>&quot;a = %d, data-&gt;a = %d, data-&gt;b = %s, c = %s</span><span class=se>\r\n</span><span class=s>&quot;</span><span class=p>,</span><span class=w> </span><span class=n>a</span><span class=p>,</span><span class=w> </span><span class=n>data</span><span class=o>-&gt;</span><span class=n>a</span><span class=p>,</span><span class=w> </span><span class=n>data</span><span class=o>-&gt;</span><span class=n>b</span><span class=p>,</span><span class=w> </span><span class=n>c</span><span class=p>);</span>
<a id=__codelineno-23-9 name=__codelineno-23-9 href=#__codelineno-23-9></a><span class=p>}</span>
<a id=__codelineno-23-10 name=__codelineno-23-10 href=#__codelineno-23-10></a><span class=n>SHELL_EXPORT_CMD_SIGN</span><span class=p>(</span><span class=n>SHELL_CMD_PERMISSION</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>|</span><span class=n>SHELL_CMD_TYPE</span><span class=p>(</span><span class=n>SHELL_TYPE_CMD_FUNC</span><span class=p>),</span>
<a id=__codelineno-23-11 name=__codelineno-23-11 href=#__codelineno-23-11></a><span class=n>paramParserTest</span><span class=p>,</span><span class=w> </span><span class=n>shellParamParserTest</span><span class=p>,</span><span class=w> </span><span class=n>test</span><span class=w> </span><span class=n>function</span><span class=w> </span><span class=n>signature</span><span class=w> </span><span class=n>and</span><span class=w> </span><span class=n>param</span><span class=w> </span><span class=n>parser</span><span class=p>,</span><span class=w> </span><span class=n>iLTestStruct</span><span class=p>;</span><span class=n>s</span><span class=p>);</span>
</code></pre></div> <p>同时，我们需要对自定义的类型定义解析器，使用 <code>SHELL_EXPORT_PARAM_PARSER</code> 宏</p> <div class=highlight><pre><span></span><code><a id=__codelineno-24-1 name=__codelineno-24-1 href=#__codelineno-24-1></a><span class=kt>int</span><span class=w> </span><span class=nf>testStructParser</span><span class=p>(</span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>string</span><span class=p>,</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=o>**</span><span class=n>param</span><span class=p>)</span>
<a id=__codelineno-24-2 name=__codelineno-24-2 href=#__codelineno-24-2></a><span class=p>{</span>
<a id=__codelineno-24-3 name=__codelineno-24-3 href=#__codelineno-24-3></a><span class=w>    </span><span class=n>TestStruct</span><span class=w> </span><span class=o>*</span><span class=n>data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>malloc</span><span class=p>(</span><span class=k>sizeof</span><span class=p>(</span><span class=n>TestStruct</span><span class=p>));</span>
<a id=__codelineno-24-4 name=__codelineno-24-4 href=#__codelineno-24-4></a><span class=w>    </span><span class=n>data</span><span class=o>-&gt;</span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>malloc</span><span class=p>(</span><span class=mi>16</span><span class=p>);</span>
<a id=__codelineno-24-5 name=__codelineno-24-5 href=#__codelineno-24-5></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>sscanf</span><span class=p>(</span><span class=n>string</span><span class=p>,</span><span class=w> </span><span class=s>&quot;%d %s&quot;</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=p>(</span><span class=n>data</span><span class=o>-&gt;</span><span class=n>a</span><span class=p>),</span><span class=w> </span><span class=n>data</span><span class=o>-&gt;</span><span class=n>b</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>2</span><span class=p>)</span>
<a id=__codelineno-24-6 name=__codelineno-24-6 href=#__codelineno-24-6></a><span class=w>    </span><span class=p>{</span>
<a id=__codelineno-24-7 name=__codelineno-24-7 href=#__codelineno-24-7></a><span class=w>        </span><span class=o>*</span><span class=n>param</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=p>)</span><span class=n>data</span><span class=p>;</span>
<a id=__codelineno-24-8 name=__codelineno-24-8 href=#__codelineno-24-8></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
<a id=__codelineno-24-9 name=__codelineno-24-9 href=#__codelineno-24-9></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-24-10 name=__codelineno-24-10 href=#__codelineno-24-10></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span>
<a id=__codelineno-24-11 name=__codelineno-24-11 href=#__codelineno-24-11></a><span class=p>}</span>
<a id=__codelineno-24-12 name=__codelineno-24-12 href=#__codelineno-24-12></a>
<a id=__codelineno-24-13 name=__codelineno-24-13 href=#__codelineno-24-13></a><span class=kt>int</span><span class=w> </span><span class=nf>testStructClener</span><span class=p>(</span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=n>param</span><span class=p>)</span>
<a id=__codelineno-24-14 name=__codelineno-24-14 href=#__codelineno-24-14></a><span class=p>{</span>
<a id=__codelineno-24-15 name=__codelineno-24-15 href=#__codelineno-24-15></a><span class=w>    </span><span class=n>TestStruct</span><span class=w> </span><span class=o>*</span><span class=n>data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>TestStruct</span><span class=w> </span><span class=o>*</span><span class=p>)</span><span class=n>param</span><span class=p>;</span>
<a id=__codelineno-24-16 name=__codelineno-24-16 href=#__codelineno-24-16></a><span class=w>    </span><span class=n>free</span><span class=p>(</span><span class=n>data</span><span class=o>-&gt;</span><span class=n>b</span><span class=p>);</span>
<a id=__codelineno-24-17 name=__codelineno-24-17 href=#__codelineno-24-17></a><span class=w>    </span><span class=n>free</span><span class=p>(</span><span class=n>data</span><span class=p>);</span>
<a id=__codelineno-24-18 name=__codelineno-24-18 href=#__codelineno-24-18></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
<a id=__codelineno-24-19 name=__codelineno-24-19 href=#__codelineno-24-19></a><span class=p>}</span>
<a id=__codelineno-24-20 name=__codelineno-24-20 href=#__codelineno-24-20></a><span class=n>SHELL_EXPORT_PARAM_PARSER</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>LTestStruct</span><span class=p>;,</span><span class=w> </span><span class=n>testStructParser</span><span class=p>,</span><span class=w> </span><span class=n>testStructClener</span><span class=p>);</span>
</code></pre></div> <p><code>SHELL_EXPORT_PARAM_PARSER</code> 接收四个参数，第一个参数表示属性，这里一般填 0 皆可，第二个参数就是解析器对应的类型签名，第三个参数是解析器函数，第四个参数是清理函数，清理函数在参数解析失败或者命令执行完毕后会被调用，一般用于清理解析器分配的内存，如果不需要清理函数，填 <code>NULL</code> 即可</p> <p>解析器函数接收两个参数，第一个参数是输入的字符串，也就是命令行输入的参数，第二个参数是解析后的参数，解析成功后，需要将解析后的参数赋值给第二个参数，解析成功返回 0，解析失败返回 -1</p> <p>清理函数接收一个参数，就是解析器函数解析得到的结果</p> <h3 id=_15>数组参数<a class=headerlink href=#_15 title="Permanent link">&para;</a></h3> <p>letter shell 3.2.2 之后，基于函数签名，我们支持了对数组参数的直接解析，使用时，需要打开宏 <code>SHELL_SUPPORT_ARRAY_PARAM</code>, 并且配置好 <code>SHELL_MALLOC</code> 和 <code>SHELL_FREE</code></p> <p>数组的参数签名，只需要在常规参数签名前加上 <code>[</code>, 比如，对于 <code>int</code> 类型的数组，他的签名为 <code>[i</code></p> <p>命令行调用时，数组参数使用 <code>[]</code> 包裹，每个元素之间用 <code>,</code> 分隔，比如 <code>func [1,2,3,4]</code></p> <div class=highlight><pre><span></span><code><a id=__codelineno-25-1 name=__codelineno-25-1 href=#__codelineno-25-1></a><span class=kt>int</span><span class=w> </span><span class=nf>shellArrayTest</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>a</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=o>*</span><span class=n>b</span><span class=p>,</span><span class=w> </span><span class=n>TestStruct</span><span class=w> </span><span class=o>**</span><span class=n>datas</span><span class=p>)</span>
<a id=__codelineno-25-2 name=__codelineno-25-2 href=#__codelineno-25-2></a><span class=p>{</span>
<a id=__codelineno-25-3 name=__codelineno-25-3 href=#__codelineno-25-3></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=p>;</span>
<a id=__codelineno-25-4 name=__codelineno-25-4 href=#__codelineno-25-4></a><span class=w>    </span><span class=n>printf</span><span class=p>(</span><span class=s>&quot;a = %d, b = %p, datas = %p</span><span class=se>\r\n</span><span class=s>&quot;</span><span class=p>,</span><span class=w> </span><span class=n>a</span><span class=p>,</span><span class=w> </span><span class=n>b</span><span class=p>,</span><span class=w> </span><span class=n>datas</span><span class=p>);</span>
<a id=__codelineno-25-5 name=__codelineno-25-5 href=#__codelineno-25-5></a><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>shellGetArrayParamSize</span><span class=p>(</span><span class=n>b</span><span class=p>);</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
<a id=__codelineno-25-6 name=__codelineno-25-6 href=#__codelineno-25-6></a><span class=w>    </span><span class=p>{</span>
<a id=__codelineno-25-7 name=__codelineno-25-7 href=#__codelineno-25-7></a><span class=w>        </span><span class=n>printf</span><span class=p>(</span><span class=s>&quot;b[%d] = %d</span><span class=se>\r\n</span><span class=s>&quot;</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>,</span><span class=w> </span><span class=n>b</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
<a id=__codelineno-25-8 name=__codelineno-25-8 href=#__codelineno-25-8></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-25-9 name=__codelineno-25-9 href=#__codelineno-25-9></a><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>shellGetArrayParamSize</span><span class=p>(</span><span class=n>datas</span><span class=p>);</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span>
<a id=__codelineno-25-10 name=__codelineno-25-10 href=#__codelineno-25-10></a><span class=w>    </span><span class=p>{</span>
<a id=__codelineno-25-11 name=__codelineno-25-11 href=#__codelineno-25-11></a><span class=w>        </span><span class=n>printf</span><span class=p>(</span><span class=s>&quot;datas[%d]-&gt;a = %d, datas[%d]-&gt;b = %s</span><span class=se>\r\n</span><span class=s>&quot;</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>,</span><span class=w> </span><span class=n>datas</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>-&gt;</span><span class=n>a</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>,</span><span class=w> </span><span class=n>datas</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>-&gt;</span><span class=n>b</span><span class=p>);</span>
<a id=__codelineno-25-12 name=__codelineno-25-12 href=#__codelineno-25-12></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-25-13 name=__codelineno-25-13 href=#__codelineno-25-13></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
<a id=__codelineno-25-14 name=__codelineno-25-14 href=#__codelineno-25-14></a><span class=p>}</span>
<a id=__codelineno-25-15 name=__codelineno-25-15 href=#__codelineno-25-15></a><span class=n>SHELL_EXPORT_CMD_SIGN</span><span class=p>(</span><span class=n>SHELL_CMD_PERMISSION</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>|</span><span class=n>SHELL_CMD_TYPE</span><span class=p>(</span><span class=n>SHELL_TYPE_CMD_FUNC</span><span class=p>),</span>
<a id=__codelineno-25-16 name=__codelineno-25-16 href=#__codelineno-25-16></a><span class=n>arrayTest</span><span class=p>,</span><span class=w> </span><span class=n>shellArrayTest</span><span class=p>,</span><span class=w> </span><span class=n>test</span><span class=w> </span><span class=n>array</span><span class=w> </span><span class=n>param</span><span class=w> </span><span class=n>parser</span><span class=p>,</span><span class=w> </span><span class=n>i</span><span class=p>[</span><span class=n>i</span><span class=p>[</span><span class=n>LTestStruct</span><span class=p>;);</span>
</code></pre></div> <p>命令执行如下</p> <div class=highlight><pre><span></span><code><a id=__codelineno-26-1 name=__codelineno-26-1 href=#__codelineno-26-1></a>letter:/workspaces/letter-shell/demo/x86-gcc$<span class=w> </span>arrayTest<span class=w> </span><span class=m>12</span><span class=w> </span><span class=o>[</span><span class=m>65</span>,<span class=w> </span><span class=m>89</span>,<span class=w> </span><span class=m>45</span><span class=o>]</span><span class=w> </span><span class=o>[</span><span class=s2>&quot;100 hello&quot;</span>,<span class=w> </span><span class=s2>&quot;56 world&quot;</span><span class=o>]</span>
<a id=__codelineno-26-2 name=__codelineno-26-2 href=#__codelineno-26-2></a><span class=nv>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=m>12</span>,<span class=w> </span><span class=nv>b</span><span class=w> </span><span class=o>=</span><span class=w> </span>0x1d2db24,<span class=w> </span><span class=nv>datas</span><span class=w> </span><span class=o>=</span><span class=w> </span>0x1d2db44
<a id=__codelineno-26-3 name=__codelineno-26-3 href=#__codelineno-26-3></a>b<span class=o>[</span><span class=m>0</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=m>65</span>
<a id=__codelineno-26-4 name=__codelineno-26-4 href=#__codelineno-26-4></a>b<span class=o>[</span><span class=m>1</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=m>89</span>
<a id=__codelineno-26-5 name=__codelineno-26-5 href=#__codelineno-26-5></a>b<span class=o>[</span><span class=m>2</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=m>45</span>
<a id=__codelineno-26-6 name=__codelineno-26-6 href=#__codelineno-26-6></a>datas<span class=o>[</span><span class=m>0</span><span class=o>]</span>-&gt;a<span class=w> </span><span class=o>=</span><span class=w> </span><span class=m>100</span>,<span class=w> </span>datas<span class=o>[</span><span class=m>0</span><span class=o>]</span>-&gt;b<span class=w> </span><span class=o>=</span><span class=w> </span>hello
<a id=__codelineno-26-7 name=__codelineno-26-7 href=#__codelineno-26-7></a>datas<span class=o>[</span><span class=m>1</span><span class=o>]</span>-&gt;a<span class=w> </span><span class=o>=</span><span class=w> </span><span class=m>56</span>,<span class=w> </span>datas<span class=o>[</span><span class=m>1</span><span class=o>]</span>-&gt;b<span class=w> </span><span class=o>=</span><span class=w> </span>world
<a id=__codelineno-26-8 name=__codelineno-26-8 href=#__codelineno-26-8></a>Return:<span class=w> </span><span class=m>0</span>,<span class=w> </span>0x00000000
</code></pre></div> <p>注意，使用数组参数时，<code>char</code>，<code>short</code>，<code>int</code> 不可以共用 <code>i</code> 的签名，需要分别使用 <code>q</code> (quarter), <code>h</code> (half)</p> <h2 id=_16>权限系统说明<a class=headerlink href=#_16 title="Permanent link">&para;</a></h2> <p>letter shell 3.x的权限管理同用户定义紧密相关，letter shell 3.x使用8个bit位表示命令权限，当用户和命令的权限按位与为真，或者命令权限为0时，表示该用户拥有此命令的权限，可以调用该命令</p> <h2 id=_17>锁说明<a class=headerlink href=#_17 title="Permanent link">&para;</a></h2> <p>letter shell 3.1增加了shell锁，主要目的是为了防止shell输出和其他输入(比如说日志)对终端的竞争，导致输出混乱的现象，如果使用场景中没有出现终端输出混乱的情况，可以不使用shell锁</p> <p>注意: 请使用支持嵌套的锁</p> <ol> <li> <p>使能宏并实现锁</p> <p>使能<code>SHELL_USING_LOCK</code>宏，实现shell上锁和解锁函数，函数原型如下：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-27-1 name=__codelineno-27-1 href=#__codelineno-27-1></a><span class=cm>/**</span>
<a id=__codelineno-27-2 name=__codelineno-27-2 href=#__codelineno-27-2></a><span class=cm> * @brief shell上锁</span>
<a id=__codelineno-27-3 name=__codelineno-27-3 href=#__codelineno-27-3></a><span class=cm> *</span>
<a id=__codelineno-27-4 name=__codelineno-27-4 href=#__codelineno-27-4></a><span class=cm> * @param struct shell_def shell对象</span>
<a id=__codelineno-27-5 name=__codelineno-27-5 href=#__codelineno-27-5></a><span class=cm> *</span>
<a id=__codelineno-27-6 name=__codelineno-27-6 href=#__codelineno-27-6></a><span class=cm> * @return 0</span>
<a id=__codelineno-27-7 name=__codelineno-27-7 href=#__codelineno-27-7></a><span class=cm> */</span>
<a id=__codelineno-27-8 name=__codelineno-27-8 href=#__codelineno-27-8></a><span class=k>typedef</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=n>shellLock</span><span class=p>)(</span><span class=k>struct</span><span class=w> </span><span class=nc>shell_def</span><span class=w> </span><span class=o>*</span><span class=p>);</span>
<a id=__codelineno-27-9 name=__codelineno-27-9 href=#__codelineno-27-9></a>
<a id=__codelineno-27-10 name=__codelineno-27-10 href=#__codelineno-27-10></a><span class=cm>/**</span>
<a id=__codelineno-27-11 name=__codelineno-27-11 href=#__codelineno-27-11></a><span class=cm> * @brief shell解锁</span>
<a id=__codelineno-27-12 name=__codelineno-27-12 href=#__codelineno-27-12></a><span class=cm> *</span>
<a id=__codelineno-27-13 name=__codelineno-27-13 href=#__codelineno-27-13></a><span class=cm> * @param struct shell_def shell对象</span>
<a id=__codelineno-27-14 name=__codelineno-27-14 href=#__codelineno-27-14></a><span class=cm> *</span>
<a id=__codelineno-27-15 name=__codelineno-27-15 href=#__codelineno-27-15></a><span class=cm> * @return 0</span>
<a id=__codelineno-27-16 name=__codelineno-27-16 href=#__codelineno-27-16></a><span class=cm> */</span>
<a id=__codelineno-27-17 name=__codelineno-27-17 href=#__codelineno-27-17></a><span class=k>typedef</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=n>shellLock</span><span class=p>)(</span><span class=k>struct</span><span class=w> </span><span class=nc>shell_def</span><span class=w> </span><span class=o>*</span><span class=p>);</span>
</code></pre></div> </li> <li> <p>使用锁</p> <p>在可能产生终端竞争的地方，加上shell锁，比如如果调用<code>shellPrint</code>进行格式化输出</p> <div class=highlight><pre><span></span><code><a id=__codelineno-28-1 name=__codelineno-28-1 href=#__codelineno-28-1></a><span class=n>SHELL_LOCK</span><span class=p>(</span><span class=n>shell</span><span class=p>);</span>
<a id=__codelineno-28-2 name=__codelineno-28-2 href=#__codelineno-28-2></a><span class=n>shellPrint</span><span class=p>(</span><span class=n>shell</span><span class=p>,</span><span class=w> </span><span class=p>...);</span>
<a id=__codelineno-28-3 name=__codelineno-28-3 href=#__codelineno-28-3></a><span class=n>SHELL_UNLOCK</span><span class=p>(</span><span class=n>shell</span><span class=p>);</span>
</code></pre></div> </li> <li> <p>注意</p> <ul> <li>不要在shell命令中调用shell锁，除非实现的shell锁为可嵌套的锁</li> </ul> </li> </ol> <h2 id=_18>伴生对象<a class=headerlink href=#_18 title="Permanent link">&para;</a></h2> <p>letter shell 3.0.3版本引入了伴生对象的概念，通过宏<code>SHELL_USING_COMPANION</code>开启或者关闭，若使用伴生对象的功能，需要同时将shell_companion.c文件加入到工程中，伴生对象可以用于需要将某个对象同shell关联的场景，比如说，通过快捷键控制shell终端对应的日志打印对象</p> <p>一般情况下，使用<code>shellCompanionAdd</code>将伴生对象同shell对象进行关联，之后，可以在shell操作中，通过<code>shellCompanionGet</code>获取相应的伴生对象，以达到在不同的shell中，操作不同对象的目的</p> <h2 id=_19>尾行模式<a class=headerlink href=#_19 title="Permanent link">&para;</a></h2> <p>letter shell 3.0.4版本新增了尾行模式，适用于需要在shell所使用的交互终端同时输入其他信息(比如说日志)时，防止其他信息的输出，导致shell交互体验极差的情况，使用时，使能宏<code>SHELL_SUPPORT_END_LINE</code>，然后对于其他需要使用终端输入信息的地方，调用<code>shellWriteEndLine</code>接口将信息输入，此时，调用<code>shellWriteEndLine</code>进行输入的内容将会插入到命令行上方，终端会一直保持shell命令行位于最后一行</p> <p>使用letter shell尾行模式结合<a href=./extensions/log/readme.md>log</a>日志输出的效果如下：</p> <p><img alt="end line mode" src=doc/img/shell_end_line_mode.gif></p> <h2 id=_20>建议终端软件<a class=headerlink href=#_20 title="Permanent link">&para;</a></h2> <ul> <li>对于基于串口移植，letter shell建议使用secureCRT软件，letter shell中的相关按键映射都是按照secureCRT进行设计的，使用其他串口软件时，可能需要修改键值</li> </ul> <h2 id=_21>命令遍历工具<a class=headerlink href=#_21 title="Permanent link">&para;</a></h2> <p>letter shell 3.x提供了一个用于遍历工程中命令导出的工具，位于tools/shellTools.py，需要python3环境运行，可以列出工程中，所有使用<code>SHELL_EXPORT_XXX</code>导出的命令名，以及位置，结合VS Code可以直接进行跳转</p> <div class=highlight><pre><span></span><code><a id=__codelineno-29-1 name=__codelineno-29-1 href=#__codelineno-29-1></a>python<span class=w> </span>shellTools.py<span class=w> </span>project
</code></pre></div> <p>注意：shellTools会遍历指定目录中所有文件，所以当工程中文件较多时，速度会比较慢，建议只用于遍历用户模块的目录</p> <h2 id=x86-demo>x86 demo<a class=headerlink href=#x86-demo title="Permanent link">&para;</a></h2> <p>letter shell 3.x提供了一个x86的demo，可以直接编译运行，其中包含了一条按键键值测试命令，可以测试按键键值，用于快捷键的定义，编译运行方法如下：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-30-1 name=__codelineno-30-1 href=#__codelineno-30-1></a><span class=nb>cd</span><span class=w> </span>demo/x86-gcc/
<a id=__codelineno-30-2 name=__codelineno-30-2 href=#__codelineno-30-2></a>cmake<span class=w> </span>.
<a id=__codelineno-30-3 name=__codelineno-30-3 href=#__codelineno-30-3></a>make
<a id=__codelineno-30-4 name=__codelineno-30-4 href=#__codelineno-30-4></a>./LetterShell
</code></pre></div> <aside class=md-source-file> <span class=md-source-file__fact> <span class=md-icon title=最后更新> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="2025年11月5日 02:47:57 UTC">2025年11月5日</span> </span> <span class=md-source-file__fact> <span class=md-icon title=创建日期> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="2025年11月5日 02:33:12 UTC">2025年11月5日</span> </span> </aside> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> 回到页面顶部 </button> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2024 OpenIBBOs Team </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["navigation.tabs", "navigation.sections", "navigation.expand", "navigation.top", "search.suggest", "search.highlight", "content.code.annotate", "content.code.copy"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script> <script src=../../assets/javascripts/bundle.f55a23d4.min.js></script> </body> </html>